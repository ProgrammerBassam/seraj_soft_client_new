name: Build and Deploy Tauri App

on:
  push:
    tags:
      - 'v*.*.*'  # ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ tag Ø¬Ø¯ÙŠØ¯ Ù…Ø«Ù„ v1.0.0

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: ðŸ›Žï¸ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ”§ Setup Node.js and Rust
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - run: npm install

      - name: ðŸš€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: ðŸ—ï¸ Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: ðŸ”¨ Build Tauri App
        run: npm run tauri build

      - name: ðŸ“¤ Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: seraj-clients
          path: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
      

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“¥ Download Built MSI
        uses: actions/download-artifact@v4
        with:
          name: seraj-clients
          path: deploy

      - name: ðŸ› ï¸ Install Dependencies (if needed)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ðŸ“¤ Upload to VPS
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          VPS_IP: "212.38.94.227"
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
          scp -o StrictHostKeyChecking=no -P 22 deploy/*.msi root@$VPS_IP:/var/www/html/updates/

          # Ø¶Ø¨Ø· Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@$VPS_IP "chmod 644 /var/www/html/updates/*.msi"

      - name: ðŸ”„ Update latest.json on VPS
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@$VPS_IP "echo '{
            \"version\": \"0.17.0\",
            \"notes\": \"ðŸš€ Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­: 0.17.0\",
            \"pub_date\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"platforms\": {
              \"windows-x86_64\": {
                \"signature\": \"PLACEHOLDER_SIGNATURE\",
                \"url\": \"http://212.38.94.227:3010/updates/seraj-clients_0.17.0_x64_en-US.msi\"
              }
            }
          }' > /var/www/html/updates/latest.json"

          # Ø¶Ø¨Ø· Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø¹Ù„Ù‰ latest.json
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@$VPS_IP "chmod 644 /var/www/html/updates/latest.json"
